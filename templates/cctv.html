<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CCTV Detection</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='cctv_style.css') }}">
  
</head>
<body>

  <!-- Navigation Buttons -->
  <div class="buttons" id="top-buttons">
    <a href="/"><button>Home</button></a>
    <a href="/image"><button>Image Detection</button></a>
    <a href="/video_page"><button>Video Detection</button></a>
    <a href="/webcam_page"><button>WebCam Detection</button></a>
  </div>

  <!-- Title -->
  <h2 id="cctv-title">CCTV Detection</h2>

  <!-- Target Input -->
  <div id="target-section">
    <input type="text" id="target-input" placeholder="Enter target objects (comma-separated)">
    <button id="set-target-btn">Set Target</button>
  </div>

  <!-- RTSP Input -->
  <div id="rtsp-section">
    <input type="text" id="rtsp-input" placeholder="Enter RTSP link (rtsp://...)">
    <button id="start-btn">Start CCTV Stream</button>
  </div>

  <!-- CCTV Container -->
  <div id="cctv-container">
    <img id="cctv-stream" src="" alt="CCTV Stream">
    <div id="alert-box"></div>
    <div id="current-target">{{ target_message }}</div>
    <button id="stop-btn" style="display:none;">Stop Stream</button>
  </div>

  <script>
  const startBtn = document.getElementById("start-btn");
  const stopBtn = document.getElementById("stop-btn");
  const topButtons = document.getElementById("top-buttons");
  const cctvTitle = document.getElementById("cctv-title");
  const cctvStream = document.getElementById("cctv-stream");
  const cctvContainer = document.getElementById("cctv-container");
  const alertBox = document.getElementById("alert-box");
  const currentTarget = document.getElementById("current-target");

  const setTargetBtn = document.getElementById("set-target-btn");
  const targetInput = document.getElementById("target-input");
  const rtspInput = document.getElementById("rtsp-input");

  let isStreaming = false;

  // Start CCTV Stream
  startBtn.addEventListener("click", () => {
    const rtspLink = rtspInput.value.trim();
    if (!rtspLink) {
      alert("Please enter a valid RTSP link.");
      return;
    }

    fetch("/start_rtsp", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "rtsp=" + encodeURIComponent(rtspLink)
    })
    .then(res => {
      if (res.ok) {
        cctvStream.src = "/rtsp_feed";
        cctvStream.onerror = () => {
          console.log("CCTV stream failed. Retrying in 3s...");
          setTimeout(() => {
            cctvStream.src = "/rtsp_feed?" + new Date().getTime(); // cache-busting
          }, 3000);
        };
        startBtn.style.display = "none";
        stopBtn.style.display = "block";
        topButtons.style.display = "none";
        cctvTitle.style.display = "none";
        document.getElementById("target-section").style.display = "none";
        cctvContainer.classList.add("fullpage");
        alertBox.innerText = "";
        alertBox.style.display = "none";
        rtspInput.value = "";
        isStreaming = true;
      } else {
        alert("Failed to start CCTV stream.");
      }
    });
  });

  // Stop CCTV Stream
  stopBtn.addEventListener("click", () => {
    fetch("/stop_cctv")
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        cctvStream.src = "";
        startBtn.style.display = "block";
        stopBtn.style.display = "none";
        topButtons.style.display = "block";
        cctvTitle.style.display = "block";
        document.getElementById("target-section").style.display = "block";
        cctvContainer.classList.remove("fullpage");
        alertBox.style.display = "none";
        isStreaming = false;
      });
  });

  // Set Target Objects
  setTargetBtn.addEventListener("click", () => {
    const targets = targetInput.value.trim();
    fetch("/set_target", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "targets=" + encodeURIComponent(targets)
    })
    .then(res => res.json())
    .then(data => {
      currentTarget.innerText = data.message;
      targetInput.value = "";
    });
  });

  // Fetch alerts continuously
  setInterval(() => {
    if (isStreaming) {
      fetch("/get_alert")
        .then(res => res.json())
        .then(data => {
          if (data.alert) {
            alertBox.innerText = data.alert;
            alertBox.style.display = "block";
            alertBox.style.border = "2px solid red";
            alertBox.style.backgroundColor = "rgba(255,0,0,0.2)";
          } else {
            alertBox.style.display = "none";
            alertBox.style.border = "none";
            alertBox.style.backgroundColor = "transparent";
          }
        });
    }
  }, 500);
  </script>

</body>
</html>
